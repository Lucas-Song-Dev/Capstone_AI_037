name: DDR5 Power Model - Regression Test

on:
  # Run on pull requests
  pull_request:
    branches: [ main, master, develop, test ]
  
  # Run on pushes to main/master to update baseline
  push:
    branches: [ main, master ]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      update_baseline:
        description: 'Update baseline (yes/no)'
        required: false
        default: 'no'

jobs:
  power-model-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        echo ""
        echo "Source files:"
        ls -la src/ || echo "No src/ directory"
        echo ""
        echo "Workload files:"
        ls -la workloads/ || echo "No workloads/ directory"
        echo ""
        echo "Verification files:"
        ls -la verif/ || echo "No verif/ directory"
    
    - name: Check if baseline exists
      id: check_baseline
      run: |
        if [ -f "verif/baseline/power_output_baseline.json" ]; then
          echo "baseline_exists=true" >> $GITHUB_OUTPUT
          echo "âœ“ Baseline found at verif/baseline/power_output_baseline.json"
        else
          echo "baseline_exists=false" >> $GITHUB_OUTPUT
          echo "âš  No baseline found - will create on first run"
        fi
    
    # On push to main/master: Always update baseline
    - name: Create/Update Baseline (on main/master push)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "::group::Updating Power Model Baseline"
        python test_regression.py --save-baseline
        echo "::endgroup::"
    
    # On manual trigger: Update baseline if requested
    - name: Create/Update Baseline (manual)
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.update_baseline == 'yes'
      run: |
        echo "::group::Updating Power Model Baseline"
        python test_regression.py --save-baseline
        echo "::endgroup::"
    
    # On PR: Run full verification test suite
    - name: Run Power Model Verification Tests (PR)
      if: github.event_name == 'pull_request'
      run: |
        echo "::group::Running DDR5 Power Model Verification Suite"
        if [ "${{ steps.check_baseline.outputs.baseline_exists }}" = "true" ]; then
          echo "Running tests against existing baseline..."
          python test_regression.py
        else
          echo "::warning::No baseline found. Creating initial baseline..."
          python test_regression.py --save-baseline
          echo "::notice::Baseline created. Future PRs will be compared against this baseline."
        fi
        echo "::endgroup::"
    
    - name: Display baseline values
      if: always()
      run: |
        if [ -f "verif/baseline/power_output_baseline.json" ]; then
          echo "Current Power Model Baseline:"
          cat verif/baseline/power_output_baseline.json
        fi
    
    - name: Upload test results as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: power-model-test-results
        path: |
          verif/baseline/
          verif/test_inputs/
        retention-days: 30
    
    - name: Commit updated baseline (if on main/master)
      if: |
        (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.update_baseline == 'yes')
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add verif/baseline/
        git diff --staged --quiet || git commit -m "chore: update power model baseline [skip ci]"
        git push || echo "No changes to push"
    
    - name: Comment on PR with test results
      if: github.event_name == 'pull_request' && steps.check_baseline.outputs.baseline_exists == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## âš¡ DDR5 Power Model - Test Results\n\n';
          
          try {
            // Read the power model baseline
            const baseline = JSON.parse(fs.readFileSync('verif/baseline/power_output_baseline.json', 'utf8'));
            
            comment += 'âœ… **Test Status:** All verification tests passed\n\n';
            comment += '### Power Model Output:\n\n';
            comment += '| Component | Power (W) |\n';
            comment += '|-----------|----------:|\n';
            
            // Display key power metrics
            const keyMetrics = [
              'P_total_core',
              'P_VDD_core', 
              'P_VPP_core',
              'P_ACT_STBY_core',
              'P_PRE_STBY_core',
              'P_RD_core',
              'P_WR_core',
              'P_REF_core'
            ];
            
            for (const key of keyMetrics) {
              if (baseline[key] !== undefined) {
                const label = key.replace('P_', '').replace('_core', '').replace(/_/g, ' ');
                comment += `| ${label} | ${baseline[key].toFixed(6)} |\n`;
              }
            }
            
            comment += '\n### Tests Passed:\n';
            comment += '- âœ… **NF-01:** Background power sensibility check\n';
            comment += '- âœ… **NF-02:** Runtime performance (< 10 seconds)\n';
            comment += '- âœ… **C-03:** Input format validation\n';
            comment += '- âœ… **F-02:** Regression validation (outputs match baseline)\n';
            
            comment += '\nðŸ“Š Full test results available in workflow artifacts.\n';
            
          } catch (err) {
            comment += `âš ï¸ Could not read test results.\n\nError: ${err.message}\n`;
            comment += '\nThe tests may have failed or the baseline may not exist yet.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

